<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-42SQV5RQNV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-42SQV5RQNV');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar - EduGator</title>
  <script>
    // Check localStorage and set data-auth attribute immediately
    (function() {
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      document.documentElement.setAttribute('data-auth', isLoggedIn ? 'in' : 'out');
    })();
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #f4f4f4; }
    nav { background-color: #333; }
    .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; gap: 2rem; height: 70px; }
    .nav-left { display: flex; align-items: center; gap: 2rem; flex: 1; min-height: 38px; }
    .logo img { height: 30px; width: auto; display: block; }
    .nav-menu { list-style: none; display: flex; gap: 2rem; align-items: center; }
    .nav-item { position: relative; display: flex; align-items: center; }
    .nav-link { color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; transition: background-color .3s; display: flex; align-items: center; }
    /* Auth-based nav visibility */
    .nav-auth-in {
      display: none !important;
    }
    html[data-auth="in"] .nav-auth-in {
      display: flex !important;
    }
    html[data-auth="in"] .nav-auth-out {
      display: none !important;
    }
    html[data-auth="out"] .nav-auth-in {
      display: none !important;
    }
    .inbox-icon img {
      height: 24px;
      width: 24px;
      display: block;
      filter: brightness(0) invert(1);
    }
    .nav-link:hover { background-color: #555; }
    .dropdown { position: absolute; top: 100%; left: 0; background-color: #444; min-width: 200px; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,.1); display: none; z-index: 1000; }
    /* Change hover to a class that JS can control on mobile/desktop */
    .nav-item:hover .dropdown, .dropdown-active { display: block; } 
    .dropdown-item { display: block; color: white; text-decoration: none; padding: .75rem 1rem; border-bottom: 1px solid #555; transition: background-color .3s; }
    .dropdown-item:hover { background-color: #555; }
    .dropdown-item:last-child { border-bottom: none; }


    .page {
      max-width: 1200px; 
      margin: 2rem auto; 
      padding: 0 2rem;
    }

    .calendar-header {
      background: white;
      border-radius: 12px;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .calendar-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: #333;
    }
    .calendar-nav {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .nav-btn {
      background: #2f4ba5;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .nav-btn:hover {
      background: #1e3a8a;
    }
    .today-btn {
      background: #10b981;
    }
    .today-btn:hover {
      background: #059669;
    }

    .calendar-grid {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 1.5rem;
    }
    .weekday-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      margin-bottom: 1px;
      background: #e5e7eb;
      border-radius: 8px 8px 0 0;
      overflow: hidden;
    }
    .weekday {
      background: #f3f4f6;
      padding: 0.75rem;
      text-align: center;
      font-weight: 700;
      color: #333;
      font-size: 0.9rem;
    }
    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
    }
    .day-cell {
      background: white;
      min-height: 120px;
      padding: 0.5rem;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }
    .day-cell:hover {
      background: #f9fafb;
    }
    .day-cell.other-month {
      background: #f9fafb;
      opacity: 0.5;
    }
    .day-cell.today {
      background: #eff6ff;
    }
    .day-number {
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    .day-cell.today .day-number {
      color: #2f4ba5;
      background: #dbeafe;
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
    }
    .session-pill {
      background: #e8eefc;
      color: #2f4ba5;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border-left: 3px solid #2f4ba5;
    }
    .session-pill.one-on-one {
      background: #fef3c7;
      color: #92400e;
      border-left-color: #f59e0b;
    }
    .session-pill:hover {
      transform: scale(1.02);
    }
    .more-sessions {
      font-size: 0.75rem;
      color: #666;
      margin-top: 0.25rem;
      font-weight: 600;
    }

    /* Session Detail Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 1.5rem;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      font-size: 1.5rem;
      color: #333;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
    }
    .modal-body {
      padding: 1.5rem;
    }
    .session-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }
    .session-type {
      font-weight: 700;
      color: #333;
      text-transform: capitalize;
      font-size: 1.1rem;
    }
    .session-status {
      background: #10b981;
      color: white;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .session-meta {
      color: #666;
      font-size: 0.95rem;
      margin: 0.4rem 0;
    }
    .session-tutor {
      font-weight: 700;
      color: #2f4ba5;
    }
    .book-button {
      background: #2f4ba5;
      color: white;
      border: none;
      padding: 0.65rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 0.75rem;
      font-size: 0.95rem;
      width: 100%;
    }
    .book-button:hover {
      background: #1e3a8a;
    }
    .empty-state {
      text-align: center;
      color: #999;
      padding: 2rem;
      font-style: italic;
    }

    .legend {
      display: flex;
      gap: 2rem;
      justify-content: center;
      margin-bottom: 1.1rem;
      font-size: 0.9rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: background 0.2s, opacity 0.2s;
      user-select: none;
    }
    .legend-item:hover {
      background: #f3f4f6;
    }
    .legend-item.inactive {
      opacity: 0.4;
      text-decoration: line-through;
    }
    .legend-item.inactive:hover {
      opacity: 0.6;
    }
    .legend-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border-left: 3px solid;
    }
    .legend-box.open {
      background: #e8eefc;
      border-left-color: #2f4ba5;
    }
    .legend-box.one-on-one {
      background: #fef3c7;
      border-left-color: #f59e0b;
    }
    .session-pill.course {
      background: #d1fae5;
      color: #065f46;
      border-left-color: #10b981;
    }
    .legend-box.course {
      background: #d1fae5;
      border-left-color: #10b981;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #333;
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999;
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      max-width: 90%;
      text-align: center;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .toast.info {
      background: #2f4ba5;
    }
    .toast.success {
      background: #10b981;
    }
    .toast.error {
      background: #ef4444;
    }
    /* Responsive Navbar Styles */
    .menu-toggle {
        display: none; /* Hide toggle button on desktop */
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 1001; /* Ensure it's above the menu when open */
        padding: 0;
        width: 30px; /* Define button size */
        height: 25px;
        position: relative; /* For absolute positioning of bars */
    }

    /* Style for the hamburger bars */
    .menu-toggle span {
        display: block;
        width: 30px;
        height: 3px;
        margin: 5px 0;
        background-color: white;
        transition: all 0.4s ease-in-out;
        border-radius: 2px;
    }

    /* Transformation for the 'X' shape when menu is active */
    .menu-toggle.active .bar1 {
        transform: translate(0, 8px) rotate(-45deg);
    }

    .menu-toggle.active .bar2 {
        opacity: 0;
    }

    .menu-toggle.active .bar3 {
        transform: translate(0, -8px) rotate(45deg);
    }

    @media (max-width: 720px) { 
        .menu-toggle {
            display: block; /* Show toggle button on mobile */
        }

        .nav-menu {
            display: none; /* Hide menu by default on mobile */
            flex-direction: column;
            width: 100%;
            position: absolute;
            top: 68px; /* Position right below the nav bar */
            left: 0;
            background-color: #333;
            box-shadow: 0 4px 6px rgba(0,0,0,.1);
            padding: 1rem 0;
            gap: 0;
        }

        .nav-menu.active {
            display: flex; /* Show menu when active class is present */
        }

        .nav-item {
            width: 100%;
        }

        .nav-link {
            display: block;
            padding: 0.75rem 2rem;
            text-align: left;
        }

        .dropdown {
            position: static; /* Change dropdown position for mobile */
            width: 100%;
            background-color: #444;
            box-shadow: none;
            border-radius: 0;
            /* Ensure dropdown only shows with JS class on mobile */
            display: none !important; 
        }
        
        .dropdown-active.dropdown {
            display: block !important;
        }

        .dropdown-item {
            padding: 0.75rem 3rem; /* Indent dropdown items */
        }
    }

    @media (max-width: 768px) {
      .calendar-header {
        flex-direction: column;
        gap: 1rem;
      }
      .day-cell {
        min-height: 80px;
        font-size: 0.85rem;
      }
      .legend {
        flex-direction: column;
        gap: 0.5rem;
        align-items: center;
      }
    }
    
    .demo-banner {
            background-color: #06402B; /* Dark Green */
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="demo-banner">
        SFSU Software Engineering Project CSC 648-848, Fall 2025. For Demonstration Only
    </div>
  <nav>
    <div class="nav-container">
      <div class="nav-left">
        <a href="index.html" class="logo">
          <img src="public/nav_logo.png" alt="EduGator Logo" />
        </a>
      </div>
      <ul class="nav-menu">
        <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
        <li class="nav-item">
          <!-- Added ID to the about link -->
          <a href="#" class="nav-link" id="aboutLink">About</a>
          <!-- Added ID to the dropdown -->
          <div class="dropdown" id="aboutDropdown">
            <a href="about/about-grady.html" class="dropdown-item">Grady Walworth - Team Lead</a>
            <a href="about/about-michael.html" class="dropdown-item">Michael Thompson - Github Lead</a>
            <a href="about/about-tejas.html" class="dropdown-item">Tejas Rajan - Frontend Lead</a>
            <a href="about/about-kameron.html" class="dropdown-item">Kameron Jacob - Frontend Developer</a>
            <a href="about/about-chris.html" class="dropdown-item">Chris Chan - Backend Lead</a>
            <a href="about/about-hardy.html" class="dropdown-item">Hardy Chang - Backend Developer</a>
          </div>
        </li>
        <li class="nav-item nav-auth-in"><a href="calendar.html" class="nav-link">Calendar</a></li>
        <li class="nav-item nav-auth-in" id="inbox-placeholder">
          <a href="inbox.html" class="nav-link inbox-icon">
            <img src="public/inbox-icon.png" alt="Messages">
          </a>
        </li>
        <li class="nav-item nav-auth-in" id="profile-placeholder"><a href="studentDashboard.html" class="nav-link">Profile</a></li>
        <li class="nav-item nav-auth-out"><a href="auth/login.html" class="nav-link">Login</a></li>
      </ul>
      <button class="menu-toggle" id="menuToggle" aria-label="Open menu">
        <span class="bar1"></span>
        <span class="bar2"></span>
        <span class="bar3"></span>
      </button>
    </div>
  </nav>

  <main class="page">
    <div class="calendar-header">
      <h1 class="calendar-title" id="currentMonth"></h1>
      <div class="calendar-nav">
        <button class="nav-btn" onclick="previousMonth()">← Previous</button>
        <button class="nav-btn today-btn" onclick="goToToday()">Today</button>
        <button class="nav-btn" onclick="nextMonth()">Next →</button>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item" id="filter-course" data-filter="course" onclick="toggleFilter('course')">
        <div class="legend-box course"></div>
        <span>My Courses</span>
      </div>
      <div class="legend-item" id="filter-open" data-filter="open" onclick="toggleFilter('open')">
        <div class="legend-box open"></div>
        <span>Open Session (Group)</span>
      </div>
      <div class="legend-item" id="filter-one-on-one" data-filter="one_on_one" onclick="toggleFilter('one_on_one')">
        <div class="legend-box one-on-one"></div>
        <span>One-on-One Session</span>
      </div>
    </div>

    <div style="text-align: center; color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
      Click any legend item above to show/hide those events
    </div>

    <div class="calendar-grid">
      <div class="weekday-header">
        <div class="weekday">Sunday</div>
        <div class="weekday">Monday</div>
        <div class="weekday">Tuesday</div>
        <div class="weekday">Wednesday</div>
        <div class="weekday">Thursday</div>
        <div class="weekday">Friday</div>
        <div class="weekday">Saturday</div>
      </div>
      <div class="days-grid" id="daysGrid"></div>
    </div>
  </main>

  <!-- Day Detail Modal -->
  <div id="dayModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalDate"></h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type;
      void toast.offsetWidth;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Store calendar events (courses and sessions)
    let calendarEvents = [];
    let coursesData = [];
    let sessionsData = [];

    // Filter state - tracks which event types are visible
    let activeFilters = {
      course: true,
      open: true,
      one_on_one: true
    };

    // Toggle filter on/off
    function toggleFilter(filterType) {
      activeFilters[filterType] = !activeFilters[filterType];
      
      // Update visual state of legend item
      const legendItem = document.getElementById(`filter-${filterType.replace(/_/g, '-')}`);
      if (activeFilters[filterType]) {
        legendItem.classList.remove('inactive');
      } else {
        legendItem.classList.add('inactive');
      }
      
      // Re-render calendar with new filters
      renderCalendar();
    }

    // Check if an event should be displayed based on active filters
    function isEventVisible(event) {
      if (event.type === 'course') {
        return activeFilters.course;
      } else if (event.type === 'session') {
        if (event.sessionType === 'one_on_one') {
          return activeFilters.one_on_one;
        } else {
          return activeFilters.open;
        }
      }
      // For demo sessions
      if (event.type === 'one_on_one') {
        return activeFilters.one_on_one;
      } else {
        return activeFilters.open;
      }
    }

    // Fetch calendar data based on user role
    async function fetchCalendarData() {
      try {
        // First, get the current user to determine their role
        const userResponse = await fetch('/api/auth/me', {
          credentials: 'include'
        });

        if (!userResponse.ok) {
          // User not logged in - show empty calendar with demo data
          console.log('User not authenticated, showing demo calendar');
          renderCalendar();
          return;
        }

        const userData = await userResponse.json();
        const userRole = userData.user?.role;

        // Determine which calendar endpoint to use based on role
        let calendarEndpoint;
        if (userRole === 'Tutor') {
          calendarEndpoint = '/api/tutors/calendar';
        } else if (userRole === 'Student') {
          calendarEndpoint = '/api/students/calendar';
        } else {
          // Unknown role, show demo calendar
          renderCalendar();
          return;
        }

        const response = await fetch(calendarEndpoint, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to fetch calendar data');
        }

        const data = await response.json();
        if (data.success) {
          coursesData = data.data.courses || [];
          sessionsData = data.data.sessions || [];

          // Convert courses and sessions to calendar events
          calendarEvents = [
            ...parseCoursesToEvents(coursesData),
            ...parseSessionsToEvents(sessionsData)
          ];

          renderCalendar();
        }
      } catch (error) {
        console.error('Error fetching calendar data:', error);
        showToast('Failed to load calendar data', 'error');
        renderCalendar(); // Show demo calendar on error
      }
    }

    // Parse course schedules into calendar events
    function parseCoursesToEvents(courses) {
      const events = [];

      courses.forEach(course => {
        if (!course.schedule) return;

        // Parse schedule formats like "MWF 10:00-11:00", "TR 14:00-15:30", etc.
        const scheduleMatch = course.schedule.match(/([MTWRFSU]+)\s+(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/i);

        if (scheduleMatch) {
          const [, days, startHour, startMin, endHour, endMin] = scheduleMatch;
          const daysMap = {
            'M': 1, 'T': 2, 'W': 3, 'R': 4, 'F': 5, 'S': 6, 'U': 0
          };

          // Create recurring events for each day
          for (const dayChar of days) {
            const dayOfWeek = daysMap[dayChar.toUpperCase()];
            if (dayOfWeek !== undefined) {
              events.push({
                type: 'course',
                courseId: course.courseId,
                title: course.code,
                fullTitle: course.title,
                dayOfWeek: dayOfWeek,
                startTime: `${startHour.padStart(2, '0')}:${startMin}`,
                endTime: `${endHour.padStart(2, '0')}:${endMin}`,
                schedule: course.schedule
              });
            }
          }
        }
      });

      return events;
    }

    // Parse sessions into calendar events
    function parseSessionsToEvents(sessions) {
      return sessions.map(session => {
        const startDate = new Date(session.startTime);
        const endDate = new Date(session.endTime);

        return {
          type: 'session',
          sessionId: session.sessionId,
          title: session.title,
          date: startDate.toISOString().split('T')[0],
          startTime: startDate.toTimeString().slice(0, 5),
          endTime: endDate.toTimeString().slice(0, 5),
          sessionType: session.sessionType,
          location: session.location,
          tutorName: session.tutorName,
          courseNames: session.courseNames,
          status: session.status,
          // Tutor-specific fields
          capacity: session.capacity,
          enrolledCount: session.enrolledCount
        };
      });
    }

    // Get events for a specific date
    function getEventsForDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const dayOfWeek = date.getDay();

      return calendarEvents.filter(event => {
        // First check if event matches the date
        let matchesDate = false;
        if (event.type === 'course') {
          // Recurring course event
          matchesDate = event.dayOfWeek === dayOfWeek;
        } else if (event.type === 'session') {
          // One-time session event
          matchesDate = event.date === dateStr;
        }
        
        // Then check if event type is currently visible
        return matchesDate && isEventVisible(event);
      });
    }

    // Demo tutoring sessions (fallback for non-logged in users)
    const DEMO_SESSIONS = [
      {
        id: 1,
        tutor: "Dr. Sarah Johnson",
        date: "2025-11-15",
        time: "14:00",
        duration: 60,
        type: "one_on_one",
        subject: "Data Structures",
        location: "Library Room 204",
        status: "available"
      },
      {
        id: 2,
        tutor: "Dr. Sarah Johnson",
        date: "2025-11-15",
        time: "16:00",
        duration: 60,
        type: "open",
        subject: "Algorithms",
        location: "Study Hall B",
        capacity: 8,
        enrolled: 5,
        status: "available"
      },
      {
        id: 3,
        tutor: "Prof. Michael Chen",
        date: "2025-11-18",
        time: "10:00",
        duration: 90,
        type: "open",
        subject: "Python Programming",
        location: "Computer Lab 3",
        capacity: 15,
        enrolled: 12,
        status: "available"
      },
      {
        id: 4,
        tutor: "Dr. Sarah Johnson",
        date: "2025-11-18",
        time: "14:30",
        duration: 60,
        type: "one_on_one",
        subject: "Machine Learning",
        location: "Online via Zoom",
        status: "available"
      },
      {
        id: 5,
        tutor: "Prof. Emily Rodriguez",
        date: "2025-11-20",
        time: "13:00",
        duration: 120,
        type: "open",
        subject: "Web Development",
        location: "Tech Building Room 105",
        capacity: 10,
        enrolled: 7,
        status: "available"
      },
      {
        id: 6,
        tutor: "Dr. James Wilson",
        date: "2025-11-22",
        time: "15:00",
        duration: 60,
        type: "one_on_one",
        subject: "Calculus",
        location: "Math Building 201",
        status: "available"
      },
      {
        id: 7,
        tutor: "Prof. Michael Chen",
        date: "2025-11-25",
        time: "11:00",
        duration: 90,
        type: "open",
        subject: "Database Design",
        location: "Computer Lab 2",
        capacity: 12,
        enrolled: 9,
        status: "available"
      },
      {
        id: 8,
        tutor: "Dr. Sarah Johnson",
        date: "2025-11-27",
        time: "10:00",
        duration: 60,
        type: "one_on_one",
        subject: "Discrete Math",
        location: "Library Room 204",
        status: "available"
      }
    ];

    let currentDate = new Date();

    function getMonthName(date) {
      return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    }

    function getSessionsForDate(dateStr) {
      // Use real data if available, otherwise fallback to demo
      if (calendarEvents.length > 0) {
        return getEventsForDate(dateStr);
      }
      // Filter demo sessions based on active filters
      return DEMO_SESSIONS.filter(session => {
        const matchesDate = session.date === dateStr;
        return matchesDate && isEventVisible(session);
      });
    }

    function formatTime(time) {
      const [hours, minutes] = time.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      document.getElementById('currentMonth').textContent = getMonthName(currentDate);
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const prevLastDay = new Date(year, month, 0);
      
      const firstDayOfWeek = firstDay.getDay();
      const lastDateOfMonth = lastDay.getDate();
      const prevLastDate = prevLastDay.getDate();
      
      const daysGrid = document.getElementById('daysGrid');
      daysGrid.innerHTML = '';
      
      // Get today's date in local timezone
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      
      // Previous month days
      for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const day = prevLastDate - i;
        const cell = createDayCell(day, true, null);
        daysGrid.appendChild(cell);
      }
      
      // Current month days
      for (let day = 1; day <= lastDateOfMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === todayStr;
        const cell = createDayCell(day, false, dateStr, isToday);
        daysGrid.appendChild(cell);
      }
      
      // Next month days
      const remainingCells = 42 - daysGrid.children.length;
      for (let day = 1; day <= remainingCells; day++) {
        const cell = createDayCell(day, true, null);
        daysGrid.appendChild(cell);
      }
    }

    function createDayCell(day, isOtherMonth, dateStr, isToday = false) {
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      if (isOtherMonth) cell.classList.add('other-month');
      if (isToday) cell.classList.add('today');

      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      dayNumber.textContent = day;
      cell.appendChild(dayNumber);

      if (dateStr) {
        const events = getSessionsForDate(dateStr);
        const displayEvents = events.slice(0, 3);

        displayEvents.forEach(event => {
          const pill = document.createElement('div');

          // Determine pill type and content based on event type
          if (event.type === 'course') {
            pill.className = 'session-pill course';
            pill.textContent = `${formatTime(event.startTime)} ${event.title}`;
            pill.title = `${event.fullTitle} (${event.schedule})`;
          } else if (event.type === 'session') {
            const typeClass = event.sessionType?.replace(/_/g, '-') || 'open';
            pill.className = `session-pill ${typeClass}`;
            pill.textContent = `${formatTime(event.startTime)} ${event.title}`;
            pill.title = `${event.tutorName} - ${event.title}`;
          } else {
            // Fallback for demo sessions
            const typeClass = event.type?.replace(/_/g, '-') || 'open';
            pill.className = `session-pill ${typeClass}`;
            pill.textContent = `${formatTime(event.time)} ${event.subject}`;
            pill.title = `${event.tutor} - ${event.subject}`;
          }

          cell.appendChild(pill);
        });

        if (events.length > 3) {
          const more = document.createElement('div');
          more.className = 'more-sessions';
          more.textContent = `+${events.length - 3} more`;
          cell.appendChild(more);
        }

        if (events.length > 0) {
          cell.onclick = () => showDayDetail(dateStr);
        }
      }

      return cell;
    }

    function showDayDetail(dateStr) {
      const events = getSessionsForDate(dateStr);
      const date = new Date(dateStr + 'T00:00:00');
      const dateDisplay = date.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });

      document.getElementById('modalDate').textContent = dateDisplay;

      const modalBody = document.getElementById('modalBody');
      if (events.length === 0) {
        modalBody.innerHTML = '<div class="empty-state">No events on this day</div>';
      } else {
        modalBody.innerHTML = events.map(event => {
          if (event.type === 'course') {
            return `
              <div class="session-card">
                <div class="session-header">
                  <span class="session-type">Course</span>
                  <span class="session-status" style="background: #10b981;">Enrolled</span>
                </div>
                <p class="session-meta"><strong>${event.title}</strong> - ${event.fullTitle}</p>
                <p class="session-meta"><strong>Time:</strong> ${formatTime(event.startTime)} - ${formatTime(event.endTime)}</p>
                <p class="session-meta"><strong>Schedule:</strong> ${event.schedule}</p>
              </div>
            `;
          } else if (event.type === 'session') {
            // Check if this is a tutor's session (has capacity info) or student's session (has tutorName)
            const isTutorSession = event.capacity !== undefined;

            return `
              <div class="session-card">
                <div class="session-header">
                  <span class="session-type">${event.sessionType?.replace('_', ' ') || 'Session'}</span>
                  <span class="session-status">${event.status}</span>
                </div>
                ${event.tutorName ? `<p class="session-meta"><span class="session-tutor">${event.tutorName}</span></p>` : ''}
                <p class="session-meta"><strong>Title:</strong> ${event.title}</p>
                <p class="session-meta"><strong>Courses:</strong> ${event.courseNames}</p>
                <p class="session-meta"><strong>Time:</strong> ${formatTime(event.startTime)} - ${formatTime(event.endTime)}</p>
                <p class="session-meta"><strong>Location:</strong> ${event.location || 'TBD'}</p>
                ${isTutorSession ? `<p class="session-meta"><strong>Enrolled:</strong> ${event.enrolledCount || 0}${event.capacity ? '/' + event.capacity : ''}</p>` : ''}
                <button class="book-button" onclick="window.location.href='session.html?id=${event.sessionId}&source=calendar'">View Session Details</button>
              </div>
            `;
          } else {
            // Demo session fallback
            return `
              <div class="session-card">
                <div class="session-header">
                  <span class="session-type">${event.type?.replace('_', ' ')}</span>
                  <span class="session-status">${event.status}</span>
                </div>
                <p class="session-meta"><span class="session-tutor">${event.tutor}</span></p>
                <p class="session-meta"><strong>Subject:</strong> ${event.subject}</p>
                <p class="session-meta"><strong>Time:</strong> ${formatTime(event.time)} (${event.duration} min)</p>
                <p class="session-meta"><strong>Location:</strong> ${event.location}</p>
                ${event.capacity ? `<p class="session-meta"><strong>Capacity:</strong> ${event.enrolled}/${event.capacity} enrolled</p>` : ''}
                <button class="book-button" onclick="window.location.href='session.html?id=${event.id}&source=calendar'">View Session Details</button>
                <button class="book-button" onclick="bookSession(${event.id})">Book This Session</button>
              </div>
            `;
          }
        }).join('');
      }

      document.getElementById('dayModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('dayModal').classList.remove('active');
    }

    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }

    function goToToday() {
      currentDate = new Date();
      renderCalendar();
    }

    function bookSession(sessionId) {
      closeModal();
      showToast('This feature will be implemented soon!', 'info');
    }

    // Initialize calendar and fetch data
    fetchCalendarData();
    // Navbar Toggle JavaScript
    const menuToggle = document.getElementById('menuToggle');
    const navMenu = document.getElementById('navMenu');
    const aboutLink = document.getElementById('aboutLink');
    const aboutDropdown = document.getElementById('aboutDropdown');

    // Main menu toggle
    menuToggle.addEventListener('click', () => {
        // Toggle 'active' class on both the menu and the button
        navMenu.classList.toggle('active');
        menuToggle.classList.toggle('active');

        // Ensure the dropdown closes when the main menu is toggled
        aboutDropdown.classList.remove('dropdown-active'); 
    });

    // Dropdown toggle for "About" link (on mobile)
    aboutLink.addEventListener('click', (e) => {
        // Check if we are on a mobile view (using a simple screen width check or similar logic)
        if (window.innerWidth <= 720) { 
            e.preventDefault(); // Prevent the link from navigating immediately
            aboutDropdown.classList.toggle('dropdown-active');
        }
    });
  </script>

  <!-- Auth utility for managing login state and nav bar -->
  <script src="js/auth.js"></script>
</body>
</html>